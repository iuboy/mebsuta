# docker-compose.yml
# å¯åŠ¨ MySQL å’Œå¯é€‰çš„ Syslog æŽ¥æ”¶å™¨ï¼Œç”¨äºŽè¿è¡Œé›†æˆæµ‹è¯•

version: '3.8'

services:
  # MySQL 8.4 - ç”¨äºŽæ¨¡æ‹Ÿæ•°æ®åº“æ—¥å¿—è¾“å‡º
  mysql:
    image: mysql:8.4
    container_name: mebsuta-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: test
      MYSQL_DATABASE: logs
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    command:
      - --binlog-format=ROW
      - --max-binlog-size=100M
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-ptest"]
      timeout: 20s
      retries: 10
      interval: 5s

  # Syslog TCP Server (RFC5424) - ä½¿ç”¨ netcat ç®€æ˜“ç›‘å¬
  syslog:
    image: alpine:latest
    container_name: mebsuta-syslog
    restart: unless-stopped
    command: >
     sh -c "
      echo 'ðŸš€ Mebsuta Syslog æœåŠ¡å·²å¯åŠ¨ï¼Œç›‘å¬ TCP 5140...' &&
      apk add --no-cache socat &&
      mkdir -p /logs &&
      while true; do
        socat TCP-LISTEN:5140,reuseaddr,fork SYSTEM:'read line; echo \"[\`date -Is\`] $$line\" >> /logs/syslog.log' &
      done
      "
    ports:
      - "5140:5140"
    volumes:
      - ./logs:/logs
    healthcheck:
      test: ["CMD", "sh", "-c", "netstat -an | grep :5140"]
      interval: 10s
      timeout: 3s
      retries: 3

volumes:
  mysql_data:
